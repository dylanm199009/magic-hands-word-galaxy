<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Magic Garden V35 (PC/Mobile Universal)</title>
    
    <!-- 1. 基础库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&display=swap');

        /* 基础重置 */
        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            overflow: hidden; font-family: 'Fredoka', sans-serif; 
            background: #87CEEB; touch-action: none; user-select: none;
        }

        #sky-gradient {
            position: fixed; inset: 0; z-index: -10; 
            background: linear-gradient(180deg, #a18cd1 0%, #fbc2eb 100%);
        }

        /* 调试条 */
        #debug-bar {
            position: fixed; top: 0; left: 0; width: 100%; 
            background: rgba(0,0,0,0.8); color: #0f0; 
            font-size: 12px; padding: 5px; z-index: 99999; text-align: center;
            pointer-events: none;
        }

        /* 1. 大厅 */
        #lobby-screen {
            position: fixed; inset: 0; z-index: 100;
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .logo h1 { color: #0984e3; font-size: clamp(32px, 6vw, 60px); margin: 0; text-shadow: 2px 2px #fff; }
        
        .tree-box { margin: 10px 0; text-align: center; }
        #magic-tree { font-size: clamp(50px, 10vw, 80px); display: block; animation: grow 2s infinite alternate; }
        @keyframes grow { from {transform: scale(1);} to {transform: scale(1.1);} }

        /* 关卡列表 */
        .level-grid {
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(90px, 1fr)); 
            gap: 15px; 
            width: 90%; max-width: 800px; max-height: 50vh; 
            overflow-y: auto; padding: 10px;
        }
        .lvl-btn {
            aspect-ratio: 1; border: none; border-radius: 15px; width: 100%;
            background: white; border-bottom: 4px solid var(--c);
            font-size: 16px; font-weight: bold; color: #555; cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: transform 0.1s, opacity 0.3s;
            opacity: 0.5; pointer-events: none; /* 默认禁用，等待AI加载 */
        }
        .lvl-btn.active { opacity: 1; pointer-events: auto; }
        .lvl-btn:active { transform: scale(0.95); }

        #status-msg { margin-top: 20px; color: #888; font-size: 14px; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }

        /* 2. HUD */
        #game-ui { position: fixed; inset: 0; pointer-events: none; z-index: 10; display: none; }
        .top-bar { 
            position: absolute; top: 20px; left: 0; width: 100%; padding: 0 20px;
            display: flex; justify-content: space-between; box-sizing: border-box; 
        }
        .score-box { font-size: 32px; color: #fdcb6e; font-weight: 900; text-shadow: 2px 2px 0 #d63031; }
        .home-btn { pointer-events: auto; padding: 8px 15px; background: #ff7675; border: none; border-radius: 10px; color: white; font-weight: bold; cursor: pointer; }

        /* 3. 卡片 (全自动 UI) */
        #card-modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 30;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: 0.3s;
        }
        #card-modal.active { opacity: 1; pointer-events: auto; }
        .card-inner {
            background: white; width: 85%; max-width: 320px; padding: 30px; border-radius: 30px; text-align: center;
            border: 6px solid #a29bfe; transform: scale(0.8); transition: 0.4s;
            display: flex; flex-direction: column; align-items: center;
        }
        #card-modal.active .card-inner { transform: scale(1); }
        #c-icon { font-size: 80px; margin-bottom: 10px; }
        #c-word { font-size: 36px; margin: 5px 0; color: #2d3436; }
        
        .mic-area { 
            margin-top: 20px; width: 100%; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
        }
        #mic-icon {
            width: 70px; height: 70px; border-radius: 50%; 
            background: #ccc; font-size: 30px; color: white; 
            display: flex; align-items: center; justify-content: center;
            transition: all 0.3s;
        }
        #mic-icon.listening {
            background: #00cec9;
            box-shadow: 0 0 0 0 rgba(0, 206, 201, 0.7);
            animation: pulse-listen 1.5s infinite;
        }
        @keyframes pulse-listen {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(0, 206, 201, 0.7); }
            70% { transform: scale(1.1); box-shadow: 0 0 0 15px rgba(0, 206, 201, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(0, 206, 201, 0); }
        }
        #timer-bar { width: 0%; height: 4px; background: #00cec9; border-radius: 2px; margin-top: 10px; transition: width 1s linear; }

        /* 4. 摄像头预览 (底层可见) */
        #input-video {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            object-fit: cover; transform: scaleX(-1);
            opacity: 0.01; z-index: -5; pointer-events: none;
        }

        /* 调试小窗 */
        #cam-preview-box {
            position: fixed; bottom: 10px; right: 10px; width: 140px; height: 105px;
            background: #000; border: 2px solid white; border-radius: 10px; z-index: 50;
            overflow: hidden; pointer-events: none;
        }
        #radar-canvas { width: 100%; height: 100%; transform: scaleX(-1); }

        #vfx-layer { position: fixed; inset: 0; pointer-events: none; z-index: 20; overflow: hidden; }
        .float-text {
            position: absolute; font-weight: 900; text-shadow: 2px 2px 0 #000;
            animation: floatUp 1s forwards; font-size: 40px; white-space: nowrap;
        }
        @keyframes floatUp {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            100% { transform: translate(-50%, -150px) scale(1.2); opacity: 0; }
        }

        #webgl-canvas { position: fixed; inset: 0; z-index: 0; }
    </style>
</head>
<body>
    <div id="debug-bar">初始化系统...</div>
    <div id="sky-gradient"></div>

    <!-- 大厅 -->
    <div id="lobby-screen">
        <div class="logo">
            <h1>🌸 奇幻花园</h1>
            <p>V35 全自动版</p>
        </div>
        <div class="tree-box">
            <div id="magic-tree">🌳</div>
            <div style="font-size:12px; color:#666">分数: <span id="total-score">0</span></div>
        </div>
        <!-- 按钮初始禁用，等待JS解锁 -->
        <div class="level-grid" id="level-grid">
            <button class="lvl-btn" onclick="tryStart('animals')" style="--c:#ff7675">🦁<br>动物</button>
            <button class="lvl-btn" onclick="tryStart('fruits')" style="--c:#fdcb6e">🍎<br>水果</button>
            <button class="lvl-btn" onclick="tryStart('colors')" style="--c:#a29bfe">🎨<br>颜色</button>
            <button class="lvl-btn" onclick="tryStart('numbers')" style="--c:#74b9ff">🔢<br>数字</button>
            <button class="lvl-btn" onclick="tryStart('body')" style="--c:#55efc4">👀<br>身体</button>
            <button class="lvl-btn" onclick="tryStart('nature')" style="--c:#00b894">🌳<br>自然</button>
            <button class="lvl-btn" onclick="tryStart('vehicles')" style="--c:#636e72">🚗<br>交通</button>
            <button class="lvl-btn" onclick="tryStart('action')" style="--c:#e17055">🏃<br>动作</button>
        </div>
        <div id="status-msg">🚀 正在加载 AI 模型 (0%)...</div>
    </div>

    <!-- HUD -->
    <div id="game-ui">
        <div class="top-bar">
            <div class="score-box">✨ <span id="score">0</span></div>
            <button class="home-btn" onclick="location.reload()">🏠</button>
        </div>
        <div id="vfx-layer"></div>
        
        <!-- 卡片 (全自动) -->
        <div id="card-modal">
            <div class="card-inner">
                <div id="c-icon">🍎</div>
                <h2 id="c-word">APPLE</h2>
                <h3 style="color:#0984e3; margin:0;" id="c-cn">苹果</h3>
                
                <div class="mic-area">
                    <div id="mic-icon">🎙️</div>
                    <div id="mic-status" style="margin-top:5px; color:#888; font-size:14px;">准备朗读...</div>
                    <div style="width:100%; background:#eee; height:4px; border-radius:2px; margin-top:10px;">
                        <div id="timer-bar"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 摄像头预览 -->
    <div id="cam-preview-box">
        <canvas id="radar-canvas"></canvas>
    </div>
    
    <!-- 视频流 -->
    <video id="input-video" playsinline webkit-playsinline muted></video>

    <canvas id="webgl-canvas"></canvas>

    <!-- 模块加载 -->
    <script type="module">
        import { FilesetResolver, HandLandmarker } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.14/+esm";

        // --- 0. 全局变量 ---
        window.THREE = THREE; 
        let handLandmarker = undefined;
        let running = false;
        let lastVideoTime = -1;
        
        // 错误处理
        function showError(msg) {
            document.getElementById('debug-bar').innerText = msg;
            console.error(msg);
        }
        window.onerror = (e) => showError("Sys Err: " + e);

        // 词库 (保持完整)
        const DB = {
            animals: [{en:'LION',cn:'狮子',i:'🦁',c:0xffa502},{en:'TIGER',cn:'老虎',i:'🐯',c:0xff6348},{en:'CAT',cn:'猫咪',i:'🐱',c:0xff6b6b},{en:'DOG',cn:'小狗',i:'🐶',c:0x54a0ff},{en:'PANDA',cn:'熊猫',i:'🐼',c:0x2f3542},{en:'RABBIT',cn:'兔子',i:'🐰',c:0xffffff},{en:'PIG',cn:'小猪',i:'🐷',c:0xffcccc},{en:'FROG',cn:'青蛙',i:'🐸',c:0x2ecc71},{en:'MONKEY',cn:'猴子',i:'🐵',c:0xd35400}],
            fruits: [{en:'APPLE',cn:'苹果',i:'🍎',c:0xff4757},{en:'BANANA',cn:'香蕉',i:'🍌',c:0xffeaa7},{en:'GRAPE',cn:'葡萄',i:'🍇',c:0xa29bfe},{en:'PEACH',cn:'桃子',i:'🍑',c:0xfdcb6e},{en:'MELON',cn:'甜瓜',i:'🍈',c:0x55efc4},{en:'CHERRY',cn:'樱桃',i:'🍒',c:0xd63031},{en:'ORANGE',cn:'橙子',i:'🍊',c:0xe67e22},{en:'WATERMELON',cn:'西瓜',i:'🍉',c:0x2ecc71}],
            colors: [{en:'RED',cn:'红色',i:'🔴',c:0xff0000},{en:'BLUE',cn:'蓝色',i:'🔵',c:0x0000ff},{en:'GREEN',cn:'绿色',i:'🟢',c:0x00ff00},{en:'YELLOW',cn:'黄色',i:'🟡',c:0xffff00},{en:'PURPLE',cn:'紫色',i:'🟣',c:0x800080},{en:'ORANGE',cn:'橙色',i:'🟠',c:0xffa500}],
            numbers: [{en:'ONE',cn:'一',i:'1️⃣',c:0x74b9ff},{en:'TWO',cn:'二',i:'2️⃣',c:0x0984e3},{en:'THREE',cn:'三',i:'3️⃣',c:0x6c5ce7},{en:'FOUR',cn:'四',i:'4️⃣',c:0xa29bfe},{en:'FIVE',cn:'五',i:'5️⃣',c:0x00cec9},{en:'TEN',cn:'十',i:'🔟',c:0x52b4bf}],
            body: [{en:'EYE',cn:'眼睛',i:'👁️',c:0xffffff},{en:'HAND',cn:'手',i:'🖐️',c:0xffcccc},{en:'NOSE',cn:'鼻子',i:'👃',c:0xf5cd79},{en:'MOUTH',cn:'嘴巴',i:'👄',c:0xff6b81}],
            vehicles: [{en:'CAR',cn:'汽车',i:'🚗',c:0xe74c3c},{en:'BUS',cn:'巴士',i:'🚌',c:0xf1c40f},{en:'PLANE',cn:'飞机',i:'✈️',c:0x3498db},{en:'SHIP',cn:'轮船',i:'🚢',c:0x34495e},{en:'ROCKET',cn:'火箭',i:'🚀',c:0x8e44ad}],
            nature: [{en:'SUN',cn:'太阳',i:'☀️',c:0xf1c40f},{en:'MOON',cn:'月亮',i:'🌙',c:0xf1c40f},{en:'STAR',cn:'星星',i:'⭐',c:0xf1c40f},{en:'TREE',cn:'树',i:'🌳',c:0x27ae60},{en:'FLOWER',cn:'花',i:'🌸',c:0xe84393}],
            action: [{en:'RUN',cn:'跑',i:'🏃',c:0xe74c3c},{en:'JUMP',cn:'跳',i:'🦘',c:0xf1c40f},{en:'SWIM',cn:'游泳',i:'🏊',c:0x3498db},{en:'DANCE',cn:'跳舞',i:'💃',c:0x9b59b6}]
        };

        let currentPool = [];
        let score = 0;
        let isPaused = false;
        let isGrabbing = false;
        let balloons = [];
        let handTarget = new THREE.Vector3(0,0,0);
        let currentWordData = null;
        let lastSpawnTime = 0;

        // --- 1. AI 初始化 ---
        async function initHandLandmarker() {
            document.getElementById('status-msg').innerText = "正在加载 AI 模型...";
            try {
                const vision = await FilesetResolver.forVisionTasks(
                    "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.14/wasm"
                );
                handLandmarker = await HandLandmarker.createFromOptions(vision, {
                    baseOptions: {
                        modelAssetPath: "https://storage.googleapis.com/mediapipe-models/hand_landmarker/hand_landmarker/float16/1/hand_landmarker.task",
                        delegate: "CPU" // 强制CPU兼容
                    },
                    runningMode: "VIDEO",
                    numHands: 1,
                    minHandDetectionConfidence: 0.3,
                    minHandPresenceConfidence: 0.3,
                    minTrackingConfidence: 0.3
                });
                
                // AI 加载完毕，解锁按钮
                document.getElementById('status-msg').innerText = "✅ 系统就绪！请点击关卡";
                document.querySelectorAll('.lvl-btn').forEach(btn => btn.classList.add('active'));
                
            } catch (error) {
                showError("AI加载失败: " + error.message);
            }
        }
        initHandLandmarker();

        // --- 2. 3D 场景 ---
        const canvas = document.getElementById('webgl-canvas');
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ canvas, alpha: true, antialias: true });
        renderer.setClearColor(0x000000, 0); // 透明背景
        
        function resize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        }
        window.addEventListener('resize', resize);
        resize();
        camera.position.z = 18;

        scene.add(new THREE.AmbientLight(0xffffff, 0.7));
        const dl = new THREE.DirectionalLight(0xffffff, 0.8);
        dl.position.set(5, 10, 5);
        scene.add(dl);

        // 主角 Avatar
        const avatar = new THREE.Group();
        const body = new THREE.Mesh(new THREE.SphereGeometry(1.2, 32, 32), new THREE.MeshPhongMaterial({color:0xffffff}));
        avatar.add(body);
        const eyeMat = new THREE.MeshBasicMaterial({color:0x000000});
        const el = new THREE.Mesh(new THREE.SphereGeometry(0.25), eyeMat); el.position.set(-0.4,0.3,1); avatar.add(el);
        const er = new THREE.Mesh(new THREE.SphereGeometry(0.25), eyeMat); er.position.set(0.4,0.3,1); avatar.add(er);
        const halo = new THREE.Mesh(new THREE.TorusGeometry(1.6,0.1,16,100), new THREE.MeshBasicMaterial({color:0xffff00}));
        halo.rotation.x = Math.PI/2;
        avatar.add(halo);
        scene.add(avatar);

        // --- 3. 气球系统 ---
        function createTex(emoji) {
            const cvs = document.createElement('canvas'); cvs.width = 256; cvs.height = 256;
            const ctx = cvs.getContext('2d');
            ctx.font = '160px Arial'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            ctx.fillText(emoji, 128, 140);
            return new THREE.CanvasTexture(cvs);
        }

        function spawnBalloon() {
            if (isPaused || currentPool.length === 0) return;
            const item = currentPool[Math.floor(Math.random() * currentPool.length)];
            const r = Math.random();
            let type = 'normal';
            if(r > 0.85) type = 'rainbow'; 
            else if(r > 0.65) type = 'gold'; 

            const group = new THREE.Group();
            let color = item.c;
            if(type === 'gold') color = 0xffd700;
            if(type === 'rainbow') color = 0xffffff;

            const mat = new THREE.MeshPhongMaterial({
                color: color, transparent: true, opacity: 0.9, 
                emissive: color, emissiveIntensity: 0.4
            });
            const sphere = new THREE.Mesh(new THREE.SphereGeometry(1.8, 32, 32), mat);
            group.add(sphere);
            
            const icon = type === 'rainbow' ? '🎁' : (type === 'gold' ? '💰' : item.i);
            const sprite = new THREE.Sprite(new THREE.SpriteMaterial({ map: createTex(icon) }));
            sprite.scale.set(2, 2, 1);
            group.add(sprite);
            
            // 响应式出生点 (适配笔记本宽屏)
            // 根据摄像机视野计算边缘
            const xEdge = (camera.aspect * camera.position.z);
            const xSpawn = xEdge + 5; 
            group.position.set(xSpawn, (Math.random()-0.5)*12, 0);
            
            group.userData = { word: item, speed: 0.1 + Math.random()*0.05, type: type };
            
            scene.add(group);
            balloons.push(group);
        }

        function spawnExplosion(pos, color, type) {
            const count = type === 'rainbow' ? 60 : 30;
            for(let i=0; i<count; i++) {
                const c = type === 'rainbow' ? Math.random()*0xffffff : color;
                const geo = Math.random() > 0.5 ? new THREE.BoxGeometry(0.4,0.4,0.4) : new THREE.SphereGeometry(0.2);
                const mat = new THREE.MeshBasicMaterial({color:c});
                const p = new THREE.Mesh(geo, mat);
                p.position.copy(pos);
                scene.add(p);
                gsap.to(p.position, { 
                    x:pos.x+(Math.random()-0.5)*12, y:pos.y+(Math.random()-0.5)*12, z:pos.z+(Math.random()-0.5)*5, 
                    duration: 1, ease: "power2.out" 
                });
                gsap.to(p.scale, { x:0, y:0, z:0, duration: 1, onComplete: ()=>scene.remove(p) });
            }
        }

        // --- 4. 循环逻辑 (Loop) ---
        const videoElement = document.getElementById('input-video');
        const radarCtx = document.getElementById('radar-canvas').getContext('2d');
        const radarCanvas = document.getElementById('radar-canvas');

        async function loop(timestamp) {
            if (!running) return;

            // AI 检测
            if (handLandmarker && videoElement.currentTime !== lastVideoTime && !videoElement.paused) {
                lastVideoTime = videoElement.currentTime;
                try {
                    const results = handLandmarker.detectForVideo(videoElement, performance.now());
                    radarCtx.clearRect(0,0,radarCanvas.width,radarCanvas.height);
                    
                    if (results.landmarks && results.landmarks.length > 0) {
                        const landmarks = results.landmarks[0];
                        const index = landmarks[8];
                        const thumb = landmarks[4];

                        // 绘制绿点
                        radarCtx.fillStyle = '#0f0'; radarCtx.beginPath();
                        radarCtx.arc((1-index.x)*radarCanvas.width, index.y*radarCanvas.height, 8, 0, Math.PI*2);
                        radarCtx.fill();

                        // 坐标映射 (适配横竖屏)
                        const aspect = camera.aspect;
                        const rangeX = aspect * camera.position.z * 1.2; // 稍微扩大范围
                        const rangeY = camera.position.z * 0.8;

                        const x = (0.5 - index.x) * (rangeX * 2); // 灵敏度 x2
                        const y = -(index.y - 0.5) * (rangeY * 2);
                        handTarget.set(x, y, 0);

                        isGrabbing = Math.hypot(index.x - thumb.x, index.y - thumb.y) < 0.05;
                    }
                } catch(e) {}
            }

            // 气球生成
            if (!isPaused && timestamp - lastSpawnTime > 1800) {
                spawnBalloon();
                lastSpawnTime = timestamp;
            }

            // 动画
            avatar.position.lerp(handTarget, 0.2);
            avatar.rotation.z = (avatar.position.x - handTarget.x) * -0.15;
            const s = isGrabbing ? 0.8 : 1.0;
            avatar.scale.setScalar(s);

            if(!isPaused) {
                const leftBound = -(camera.aspect * camera.position.z) - 5; // 动态计算左边界
                
                for(let i=balloons.length-1; i>=0; i--) {
                    const b = balloons[i];
                    b.position.x -= b.userData.speed;
                    b.position.y += Math.sin(timestamp*0.002 + i)*0.05;
                    
                    if(b.userData.type === 'rainbow') b.children[0].material.color.setHSL((timestamp*0.0005)%1, 1, 0.5);

                    if(isGrabbing && b.position.distanceTo(avatar.position) < 5) b.position.lerp(avatar.position, 0.15);

                    if(b.position.distanceTo(avatar.position) < 2.5) {
                        hit(b, i);
                    } else if(b.position.x < leftBound) {
                        scene.remove(b);
                        balloons.splice(i, 1);
                    }
                }
            }
            renderer.render(scene, camera);
            requestAnimationFrame(loop);
        }

        function hit(obj, index) {
            const data = obj.userData.word;
            const type = obj.userData.type;
            const pos = obj.position.clone();
            
            scene.remove(obj);
            balloons.splice(index, 1);
            
            spawnExplosion(pos, type === 'gold' ? 0xffd700 : data.c, type);
            
            let pts = 10;
            let txt = "+10";
            let color = "#fff";
            
            if(type === 'gold') { pts = 50; txt = "+50 💰"; color = "#ffd700"; playSynth('win'); }
            else if(type === 'rainbow') { pts = 100; txt = "RAINBOW!"; color = "#00ffff"; playSynth('win'); }
            else { playSynth('pop'); }
            
            score += pts;
            document.getElementById('score').innerText = score;
            showFloatText(txt, pos, color);

            showCard(data);
        }

        function showFloatText(txt, pos3d, color) {
            const el = document.createElement('div');
            el.className = 'float-text'; el.innerText = txt;
            el.style.color = color;
            const vec = pos3d.clone().project(camera);
            const x = (vec.x * .5 + .5) * window.innerWidth;
            const y = (-(vec.y * .5) + .5) * window.innerHeight;
            el.style.left = x + 'px'; el.style.top = y + 'px';
            document.getElementById('vfx-layer').appendChild(el);
            setTimeout(()=>el.remove(), 1000);
        }

        // --- 5. 全自动跟读逻辑 (V34 Core) ---
        const synth = window.speechSynthesis;
        let ttsTimer = null;
        let recTimer = null;
        let recognition = null;

        // 初始化语音识别
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.lang = 'en-US';
            recognition.continuous = false;
            recognition.interimResults = false;
        }

        function showCard(data) {
            isPaused = true;
            currentWordData = data;
            
            // 更新 UI
            document.getElementById('c-icon').innerText = data.i;
            document.getElementById('c-word').innerText = data.en;
            document.getElementById('c-cn').innerText = data.cn;
            document.getElementById('card-modal').classList.add('active');
            
            // 重置状态
            const micIcon = document.getElementById('mic-icon');
            micIcon.classList.remove('listening');
            micIcon.style.background = "#ccc";
            document.getElementById('mic-status').innerText = "🔊 正在朗读...";
            document.getElementById('timer-bar').style.width = "0%";
            document.getElementById('timer-bar').style.transition = "none";

            // 朗读
            synth.cancel();
            const u = new SpeechSynthesisUtterance(data.en);
            u.lang = 'en-US'; u.rate = 0.9;
            
            const startListening = () => {
                clearTimeout(ttsTimer);
                autoStartListening();
            };
            u.onend = startListening;
            u.onerror = startListening; 
            
            synth.speak(u);
            ttsTimer = setTimeout(startListening, 2000);
        }

        function autoStartListening() {
            const micIcon = document.getElementById('mic-icon');
            const status = document.getElementById('mic-status');
            const timerBar = document.getElementById('timer-bar');

            status.innerText = "👂 请跟读... (10秒)";
            micIcon.style.background = "#00cec9";
            micIcon.classList.add('listening'); 
            
            // 进度条
            timerBar.style.width = "100%";
            timerBar.style.transition = "width 10s linear";

            let hasResult = false;
            
            if (recognition) {
                try {
                    recognition.start();
                    recognition.onresult = (e) => {
                        const t = e.results[0][0].transcript.toLowerCase();
                        if (t.includes(currentWordData.en.toLowerCase())) {
                            hasResult = true;
                            finishListening(true, "Perfect!");
                        }
                    };
                } catch(e) {}
            }

            // 倒计时 (iOS 模拟成功)
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            const waitTime = isIOS ? 3000 + Math.random() * 2000 : 10000;

            recTimer = setTimeout(() => {
                if (!hasResult) {
                    if (isIOS) finishListening(true, "Great! (自动)"); 
                    else finishListening(false, "超时");
                }
            }, waitTime);
        }

        function finishListening(success, msg) {
            if (recTimer) clearTimeout(recTimer);
            if (recognition) try { recognition.stop(); } catch(e){}

            const status = document.getElementById('mic-status');
            status.innerText = success ? `🌟 ${msg}` : "😅 继续加油";
            document.getElementById('mic-icon').classList.remove('listening');

            if (success) {
                playSynth('win');
                score += 20; document.getElementById('score').innerText = score;
                spawnExplosion(avatar.position, 0xffff00, 'rainbow');
            } else {
                playSynth('pop'); 
            }

            setTimeout(closeCard, 1500);
        }

        window.closeCard = () => {
            if (recTimer) clearTimeout(recTimer);
            if (recognition) try { recognition.stop(); } catch(e){}
            document.getElementById('card-modal').classList.remove('active');
            isPaused = false;
        };

        // --- 6. 摄像头启动 ---
        async function startCamera() {
            if(!handLandmarker) { alert("AI模型正在加载..."); return; }
            try {
                // 不指定 facingMode，自动选择
                const constraints = { video: { width: { ideal: 640 }, height: { ideal: 480 } } };
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                const video = document.getElementById('input-video');
                video.srcObject = stream;
                
                video.onloadedmetadata = () => {
                    video.play();
                    // 适配 Radar
                    document.getElementById('radar-canvas').width = video.videoWidth;
                    document.getElementById('radar-canvas').height = video.videoHeight;
                    running = true;
                    requestAnimationFrame(loop);
                };
            } catch(e) {
                showError("相机错误: " + e.message);
            }
        }

        // --- 7. 音频引擎 ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSynth(type) {
            if(audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            const now = audioCtx.currentTime;
            
            if(type === 'pop') {
                osc.type = 'triangle'; osc.frequency.setValueAtTime(600, now); gain.gain.linearRampToValueAtTime(0, now+0.1); osc.start(now); osc.stop(now+0.1);
            } else if(type === 'win') {
                osc.type = 'square'; osc.frequency.setValueAtTime(500, now); gain.gain.linearRampToValueAtTime(0, now+0.3); osc.start(now); osc.stop(now+0.3);
            }
        }

        // 绑定启动 (全局)
        window.tryStart = (cat) => {
            if(!handLandmarker) return;
            
            currentPool = DB[cat];
            document.getElementById('lobby-screen').style.display = 'none';
            document.getElementById('game-ui').style.display = 'block';
            
            audioCtx.resume();
            const u = new SpeechSynthesisUtterance('');
            synth.speak(u);

            startCamera();
        };

        window.addEventListener('resize', resize);
        window.speechSynthesis.onvoiceschanged = () => window.speechSynthesis.getVoices();
    </script>
</body>
</html>