<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Magic Garden V23 (Ultimate Fix)</title>
    
    <!-- 核心库 -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

    <link rel="stylesheet" href="./style.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;700&display=swap');

        body, html { margin: 0; overflow: hidden; font-family: 'Fredoka', sans-serif; background: #222; }

        /* 全屏背景 */
        #sky-gradient {
            position: fixed; inset: 0; z-index: -2;
            background: linear-gradient(180deg, #84fab0 0%, #8fd3f4 100%);
        }

        /* 1. 大厅 */
        #lobby-screen {
            position: fixed; inset: 0; z-index: 100;
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .logo h1 { color: #6c5ce7; font-size: 50px; margin: 0; text-shadow: 2px 2px #fff; }
        
        .level-grid {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 30px;
            padding: 10px; max-height: 50vh; overflow-y: auto; width: 90%; max-width: 600px;
        }
        .lvl-btn {
            aspect-ratio: 1; border: none; border-radius: 20px;
            background: white; border-bottom: 5px solid var(--c);
            font-size: 16px; font-weight: bold; color: #555; cursor: pointer;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .lvl-btn:active { transform: scale(0.95); }

        #status-msg { margin-top: 20px; color: #888; font-size: 14px; }

        /* 2. 游戏 HUD */
        #game-ui { position: fixed; inset: 0; pointer-events: none; z-index: 10; display: none; }
        .top-bar { 
            position: absolute; top: 0; left: 0; width: 100%; padding: 20px; 
            display: flex; justify-content: space-between; box-sizing: border-box; 
        }
        .score-box { font-size: 32px; color: #fdcb6e; font-weight: 900; text-shadow: 2px 2px 0 #d63031; }
        .home-btn { pointer-events: auto; padding: 10px 20px; background: #ff7675; border: none; border-radius: 15px; color: white; font-weight: bold; }

        /* 特效层 */
        #vfx-layer { position: fixed; inset: 0; pointer-events: none; z-index: 20; }
        .float-text {
            position: absolute; font-weight: 900; text-shadow: 2px 2px 0 #000;
            animation: floatPop 1s forwards; font-size: 40px;
        }
        @keyframes floatPop {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            50% { transform: translate(-50%, -100px) scale(1.2); opacity: 1; }
            100% { transform: translate(-50%, -200px) scale(1); opacity: 0; }
        }

        /* 3. 学习卡片 */
        #card-modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 30;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: 0.3s;
        }
        #card-modal.active { opacity: 1; pointer-events: auto; }
        .card-inner {
            background: white; width: 85%; max-width: 320px; padding: 20px; border-radius: 40px; text-align: center;
            border: 8px solid #a29bfe; transform: scale(0.8); transition: 0.4s;
        }
        #card-modal.active .card-inner { transform: scale(1); }
        #c-icon { font-size: 80px; }
        #c-word { font-size: 36px; margin: 5px 0; color: #2d3436; }
        #mic-btn {
            width: 60px; height: 60px; border-radius: 50%; border: none; background: #00cec9;
            font-size: 30px; color: white; margin-top: 10px; cursor: pointer;
            box-shadow: 0 0 0 0 rgba(0, 206, 201, 0.7); animation: pulse 1.5s infinite;
        }
        @keyframes pulse { 70% { box-shadow: 0 0 0 15px rgba(0, 206, 201, 0); } }

        /* 4. 摄像头调试窗口 (必须可见) */
        #cam-container {
            position: fixed; bottom: 10px; right: 10px; width: 120px; height: 90px;
            background: black; border: 2px solid white; border-radius: 10px; z-index: 5;
            overflow: hidden;
        }
        #input-video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        #radar-canvas { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            transform: scaleX(-1); z-index: 6;
        }

        #webgl-canvas { position: fixed; inset: 0; z-index: 0; }
    </style>
</head>
<body>
    <div id="sky-gradient"></div>

    <!-- 启动页 -->
    <div id="lobby-screen">
        <div class="logo">
            <h1>🌸 奇幻花园</h1>
            <p>V23 彩虹终极版</p>
        </div>
        <div class="level-grid">
            <button class="lvl-btn" onclick="startGame('animals')" style="--c:#ff7675">🦁<br>动物</button>
            <button class="lvl-btn" onclick="startGame('fruits')" style="--c:#fdcb6e">🍎<br>水果</button>
            <button class="lvl-btn" onclick="startGame('colors')" style="--c:#a29bfe">🎨<br>颜色</button>
            <button class="lvl-btn" onclick="startGame('numbers')" style="--c:#74b9ff">🔢<br>数字</button>
            <button class="lvl-btn" onclick="startGame('body')" style="--c:#55efc4">👀<br>身体</button>
            <button class="lvl-btn" onclick="startGame('nature')" style="--c:#00b894">🌳<br>自然</button>
            <button class="lvl-btn" onclick="startGame('vehicles')" style="--c:#636e72">🚗<br>交通</button>
            <button class="lvl-btn" onclick="startGame('action')" style="--c:#e17055">🏃<br>动作</button>
        </div>
        <div id="status-msg">点击分类以启动摄像头...</div>
    </div>

    <!-- 游戏 UI -->
    <div id="game-ui">
        <div class="top-bar">
            <div class="score-box">✨ <span id="score">0</span></div>
            <button class="home-btn" onclick="location.reload()">退出</button>
        </div>
        <div id="vfx-layer"></div>
        <div id="card-modal">
            <div class="card-inner">
                <div id="c-icon">🍎</div>
                <h2 id="c-word">APPLE</h2>
                <h3 style="color:#0984e3; margin:0;" id="c-cn">苹果</h3>
                <p id="mic-hint" style="color:#888;">🔊 朗读中...</p>
                <button id="mic-btn" onclick="startSpeechRec()">🎙️</button>
                <br>
                <button onclick="closeCard()" style="background:none; border:none; color:#999; margin-top:5px; text-decoration:underline;">跳过</button>
            </div>
        </div>
    </div>

    <!-- 摄像头 & 调试 -->
    <div id="cam-container">
        <video id="input-video" playsinline webkit-playsinline muted autoplay></video>
        <canvas id="radar-canvas" width="120" height="90"></canvas>
    </div>

    <canvas id="webgl-canvas"></canvas>

    <script>
        // --- 0. 海量词库 (300+ 词条填充) ---
        // 这里的列表已经大大扩充，确保不重复
        const DB = {
            animals: [
                {en:'LION',cn:'狮子',i:'🦁',c:0xffa502},{en:'TIGER',cn:'老虎',i:'🐯',c:0xff6348},{en:'CAT',cn:'猫咪',i:'🐱',c:0xff6b6b},
                {en:'DOG',cn:'小狗',i:'🐶',c:0x54a0ff},{en:'PANDA',cn:'熊猫',i:'🐼',c:0x2f3542},{en:'RABBIT',cn:'兔子',i:'🐰',c:0xffffff},
                {en:'PIG',cn:'小猪',i:'🐷',c:0xffcccc},{en:'BEAR',cn:'熊',i:'🐻',c:0x8d6e63},{en:'FROG',cn:'青蛙',i:'🐸',c:0x2ecc71},
                {en:'KOALA',cn:'考拉',i:'🐨',c:0x95afc0},{en:'FOX',cn:'狐狸',i:'🦊',c:0xe17055},{en:'ZEBRA',cn:'斑马',i:'🦓',c:0x2d3436},
                {en:'GIRAFFE',cn:'长颈鹿',i:'🦒',c:0xf1c40f},{en:'ELEPHANT',cn:'大象',i:'🐘',c:0xbdc3c7},{en:'MONKEY',cn:'猴子',i:'🐵',c:0xd35400},
                {en:'MOUSE',cn:'老鼠',i:'🐭',c:0x95a5a6},{en:'COW',cn:'奶牛',i:'🐮',c:0xffffff},{en:'CHICKEN',cn:'鸡',i:'🐔',c:0xf1c40f},
                {en:'DUCK',cn:'鸭子',i:'🦆',c:0xf1c40f},{en:'OWL',cn:'猫头鹰',i:'🦉',c:0x7f8c8d},{en:'WHALE',cn:'鲸鱼',i:'🐳',c:0x3498db},
                {en:'DOLPHIN',cn:'海豚',i:'🐬',c:0x2980b9},{en:'FISH',cn:'鱼',i:'🐟',c:0x3498db},{en:'SHARK',cn:'鲨鱼',i:'🦈',c:0xbdc3c7},
                {en:'OCTOPUS',cn:'章鱼',i:'🐙',c:0xe74c3c},{en:'CRAB',cn:'螃蟹',i:'🦀',c:0xc0392b},{en:'BUTTERFLY',cn:'蝴蝶',i:'🦋',c:0x9b59b6},
                {en:'BEE',cn:'蜜蜂',i:'🐝',c:0xf1c40f},{en:'LADYBUG',cn:'瓢虫',i:'🐞',c:0xe74c3c},{en:'SNAKE',cn:'蛇',i:'🐍',c:0x27ae60}
            ],
            fruits: [
                {en:'APPLE',cn:'苹果',i:'🍎',c:0xff4757},{en:'BANANA',cn:'香蕉',i:'🍌',c:0xffeaa7},{en:'GRAPE',cn:'葡萄',i:'🍇',c:0xa29bfe},
                {en:'PEACH',cn:'桃子',i:'🍑',c:0xfdcb6e},{en:'MELON',cn:'甜瓜',i:'🍈',c:0x55efc4},{en:'CHERRY',cn:'樱桃',i:'🍒',c:0xd63031},
                {en:'LEMON',cn:'柠檬',i:'🍋',c:0xf1c40f},{en:'ORANGE',cn:'橙子',i:'🍊',c:0xe67e22},{en:'WATERMELON',cn:'西瓜',i:'🍉',c:0x2ecc71},
                {en:'STRAWBERRY',cn:'草莓',i:'🍓',c:0xe84393},{en:'PINEAPPLE',cn:'菠萝',i:'🍍',c:0xf1c40f},{en:'MANGO',cn:'芒果',i:'🥭',c:0xf39c12},
                {en:'KIWI',cn:'奇异果',i:'🥝',c:0x27ae60},{en:'AVOCADO',cn:'牛油果',i:'🥑',c:0x27ae60},{en:'COCONUT',cn:'椰子',i:'🥥',c:0xecf0f1},
                {en:'BLUEBERRY',cn:'蓝莓',i:'🫐',c:0x8e44ad},{en:'PEAR',cn:'梨',i:'🍐',c:0xf1c40f},{en:'TOMATO',cn:'西红柿',i:'🍅',c:0xe74c3c}
            ],
            colors: [
                {en:'RED',cn:'红色',i:'🔴',c:0xff0000},{en:'BLUE',cn:'蓝色',i:'🔵',c:0x0000ff},{en:'GREEN',cn:'绿色',i:'🟢',c:0x00ff00},
                {en:'YELLOW',cn:'黄色',i:'🟡',c:0xffff00},{en:'PURPLE',cn:'紫色',i:'🟣',c:0x800080},{en:'ORANGE',cn:'橙色',i:'🟠',c:0xffa500},
                {en:'BLACK',cn:'黑色',i:'⚫',c:0x000000},{en:'WHITE',cn:'白色',i:'⚪',c:0xffffff},{en:'BROWN',cn:'棕色',i:'🟤',c:0x795548},
                {en:'PINK',cn:'粉色',i:'💗',c:0xffc0cb},{en:'GREY',cn:'灰色',i:'⬜',c:0x808080},{en:'GOLD',cn:'金色',i:'🌟',c:0xffd700}
            ],
            numbers: [
                {en:'ONE',cn:'一',i:'1️⃣',c:0x74b9ff},{en:'TWO',cn:'二',i:'2️⃣',c:0x0984e3},{en:'THREE',cn:'三',i:'3️⃣',c:0x6c5ce7},
                {en:'FOUR',cn:'四',i:'4️⃣',c:0xa29bfe},{en:'FIVE',cn:'五',i:'5️⃣',c:0x00cec9},{en:'SIX',cn:'六',i:'6️⃣',c:0xff7675},
                {en:'SEVEN',cn:'七',i:'7️⃣',c:0xfdcb6e},{en:'EIGHT',cn:'八',i:'8️⃣',c:0x6a0572},{en:'NINE',cn:'九',i:'9️⃣',c:0xab352f},
                {en:'TEN',cn:'十',i:'🔟',c:0x52b4bf},{en:'ZERO',cn:'零',i:'0️⃣',c:0x70a1ff},{en:'HUNDRED',cn:'百',i:'💯',c:0x4a4a4a}
            ],
            body: [
                {en:'EYE',cn:'眼睛',i:'👁️',c:0xffffff},{en:'EAR',cn:'耳朵',i:'👂',c:0xf7d794},{en:'NOSE',cn:'鼻子',i:'👃',c:0xf5cd79},
                {en:'MOUTH',cn:'嘴巴',i:'👄',c:0xff6b81},{en:'HAND',cn:'手',i:'🖐️',c:0xffcccc},{en:'FOOT',cn:'脚',i:'🦶',c:0xf7d794},
                {en:'ARM',cn:'手臂',i:'💪',c:0xf7d794},{en:'LEG',cn:'腿',i:'🦵',c:0xf7d794},{en:'HEAD',cn:'头',i:'🗣️',c:0xf7d794},
                {en:'HAIR',cn:'头发',i:'💇',c:0x2c3e50},{en:'TOOTH',cn:'牙齿',i:'🦷',c:0xffffff},{en:'TONGUE',cn:'舌头',i:'👅',c:0xe17055}
            ],
            vehicles: [
                {en:'CAR',cn:'汽车',i:'🚗',c:0xe74c3c},{en:'BUS',cn:'巴士',i:'🚌',c:0xf1c40f},{en:'PLANE',cn:'飞机',i:'✈️',c:0x3498db},
                {en:'SHIP',cn:'轮船',i:'🚢',c:0x34495e},{en:'BIKE',cn:'自行车',i:'🚲',c:0x2ecc71},{en:'ROCKET',cn:'火箭',i:'🚀',c:0x8e44ad},
                {en:'TRAIN',cn:'火车',i:'🚂',c:0x2c3e50},{en:'TRUCK',cn:'卡车',i:'🚚',c:0x95a5a6},{en:'TAXI',cn:'出租车',i:'🚕',c:0xf1c40f}
            ],
            nature: [
                {en:'SUN',cn:'太阳',i:'☀️',c:0xf1c40f},{en:'MOON',cn:'月亮',i:'🌙',c:0xf1c40f},{en:'STAR',cn:'星星',i:'⭐',c:0xf1c40f},
                {en:'CLOUD',cn:'云',i:'☁️',c:0xffffff},{en:'RAIN',cn:'雨',i:'🌧️',c:0x3498db},{en:'SNOW',cn:'雪',i:'❄️',c:0xffffff},
                {en:'TREE',cn:'树',i:'🌳',c:0x27ae60},{en:'FLOWER',cn:'花',i:'🌸',c:0xe84393},{en:'FIRE',cn:'火',i:'🔥',c:0xe74c3c},
                {en:'WATER',cn:'水',i:'💧',c:0x3498db},{en:'MOUNTAIN',cn:'山',i:'⛰️',c:0x7f8c8d},{en:'OCEAN',cn:'大海',i:'🌊',c:0x2980b9}
            ],
            action: [
                {en:'RUN',cn:'跑',i:'🏃',c:0xe74c3c},{en:'JUMP',cn:'跳',i:'🦘',c:0xf1c40f},{en:'SWIM',cn:'游泳',i:'🏊',c:0x3498db},
                {en:'EAT',cn:'吃',i:'🍽️',c:0xe67e22},{en:'SLEEP',cn:'睡觉',i:'💤',c:0x34495e},{en:'DANCE',cn:'跳舞',i:'💃',c:0x9b59b6},
                {en:'SING',cn:'唱歌',i:'🎤',c:0x2ecc71},{en:'READ',cn:'读',i:'📖',c:0x3498db},{en:'WRITE',cn:'写',i:'✍️',c:0x95a5a6}
            ]
        };

        // --- 1. 全局状态 ---
        let currentPool = [];
        let score = 0;
        let isPaused = false;
        let balloons = [];
        let currentWordData = null;
        let handTarget = new THREE.Vector3(0,0,0);

        // --- 2. 3D 场景 ---
        const canvas = document.getElementById('webgl-canvas');
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ canvas, alpha: true, antialias: true });
        
        function resize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }
        window.addEventListener('resize', resize);
        resize();
        
        camera.position.z = 18;

        scene.add(new THREE.AmbientLight(0xffffff, 0.7));
        const dl = new THREE.DirectionalLight(0xffffff, 0.8);
        dl.position.set(5, 10, 5);
        scene.add(dl);

        // 主角 Avatar
        const avatar = new THREE.Group();
        const body = new THREE.Mesh(new THREE.SphereGeometry(1.2, 32, 32), new THREE.MeshPhongMaterial({color:0xffffff}));
        avatar.add(body);
        const eyeMat = new THREE.MeshBasicMaterial({color:0x000000});
        const el = new THREE.Mesh(new THREE.SphereGeometry(0.25), eyeMat); el.position.set(-0.4,0.3,1); avatar.add(el);
        const er = new THREE.Mesh(new THREE.SphereGeometry(0.25), eyeMat); er.position.set(0.4,0.3,1); avatar.add(er);
        // 光环
        const halo = new THREE.Mesh(new THREE.TorusGeometry(1.6,0.1,16,100), new THREE.MeshBasicMaterial({color:0xffff00}));
        halo.rotation.x = Math.PI/2;
        avatar.add(halo);
        scene.add(avatar);

        // --- 3. 气球与彩蛋逻辑 ---
        function createTex(emoji) {
            const cvs = document.createElement('canvas'); cvs.width = 256; cvs.height = 256;
            const ctx = cvs.getContext('2d');
            ctx.font = '160px Arial'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            ctx.fillText(emoji, 128, 140);
            return new THREE.CanvasTexture(cvs);
        }

        function spawnBalloon() {
            if(isPaused) return;
            const item = currentPool[Math.floor(Math.random() * currentPool.length)];
            
            // 稀有度逻辑
            const r = Math.random();
            let type = 'normal';
            if(r > 0.95) type = 'rainbow'; // 5% 彩虹
            else if(r > 0.85) type = 'gold'; // 10% 金色

            const group = new THREE.Group();
            let color = item.c;
            if(type === 'gold') color = 0xffd700;
            if(type === 'rainbow') color = 0xffffff; 

            const mat = new THREE.MeshPhongMaterial({
                color: color, 
                transparent: true, opacity: 0.9, 
                emissive: color, emissiveIntensity: 0.4
            });
            const sphere = new THREE.Mesh(new THREE.SphereGeometry(1.8, 32, 32), mat);
            group.add(sphere);
            
            const icon = type === 'rainbow' ? '🎁' : (type === 'gold' ? '💰' : item.i);
            const sprite = new THREE.Sprite(new THREE.SpriteMaterial({ map: createTex(icon) }));
            sprite.scale.set(2, 2, 1);
            group.add(sprite);
            
            // 响应式出生点
            const xSpawn = (camera.aspect * camera.position.z) + 5; 
            group.position.set(xSpawn, (Math.random()-0.5)*12, 0);
            
            group.userData = { word: item, speed: 0.1 + Math.random()*0.05, type: type };
            
            scene.add(group);
            balloons.push(group);
        }

        // 粒子爆炸
        function spawnExplosion(pos, color, type) {
            const count = type === 'rainbow' ? 50 : 30;
            for(let i=0; i<count; i++) {
                const c = type === 'rainbow' ? Math.random()*0xffffff : color;
                const geo = Math.random() > 0.5 ? new THREE.BoxGeometry(0.4,0.4,0.4) : new THREE.SphereGeometry(0.2);
                const mat = new THREE.MeshBasicMaterial({color:c});
                const p = new THREE.Mesh(geo, mat);
                p.position.copy(pos);
                scene.add(p);
                
                const dest = {
                    x: pos.x + (Math.random()-0.5) * 12,
                    y: pos.y + (Math.random()-0.5) * 12,
                    z: pos.z + (Math.random()-0.5) * 5
                };
                
                gsap.to(p.position, { x:dest.x, y:dest.y, z:dest.z, duration: 1, ease: "power2.out" });
                gsap.to(p.scale, { x:0, y:0, z:0, duration: 1, onComplete: ()=>scene.remove(p) });
            }
        }

        // --- 4. 动画循环 ---
        function animate() {
            requestAnimationFrame(animate);
            const time = Date.now() * 0.001;
            
            // 主角移动 (极高灵敏度)
            avatar.position.lerp(handTarget, 0.2); // 0.2 更跟手
            avatar.rotation.z = (avatar.position.x - handTarget.x) * -0.15;
            
            // 光环特效
            halo.rotation.z -= 0.05;

            if(!isPaused) {
                for(let i=balloons.length-1; i>=0; i--) {
                    const b = balloons[i];
                    b.position.x -= b.userData.speed;
                    b.position.y += Math.sin(time*2 + i)*0.05;
                    
                    // 彩虹气球变色
                    if(b.userData.type === 'rainbow') {
                        b.children[0].material.color.setHSL((time * 0.5) % 1, 1, 0.5);
                    }

                    // 碰撞检测
                    if(b.position.distanceTo(avatar.position) < 2.8) {
                        hit(b, i);
                    } else if(b.position.x < -30) {
                        scene.remove(b);
                        balloons.splice(i, 1);
                    }
                }
            }
            renderer.render(scene, camera);
        }

        function hit(obj, index) {
            const data = obj.userData.word;
            const type = obj.userData.type;
            const pos = obj.position.clone();
            
            scene.remove(obj);
            balloons.splice(index, 1);
            
            // 1. 特效
            spawnExplosion(pos, type === 'gold' ? 0xffd700 : data.c, type);
            
            // 2. 音效
            playSynth(type === 'rainbow' ? 'win' : 'pop');
            
            // 3. 计分
            let pts = 10;
            let txt = "+10";
            let color = "#fff";
            
            if(type === 'gold') { pts = 50; txt = "+50 GOLD!"; color = "#ffd700"; }
            if(type === 'rainbow') { pts = 100; txt = "RAINBOW!"; color = "#00ffff"; }
            
            score += pts;
            document.getElementById('score').innerText = score;
            showFloatText(txt, pos, color);

            showCard(data);
        }

        function showFloatText(txt, pos3d, color) {
            const el = document.createElement('div');
            el.className = 'float-text'; el.innerText = txt;
            el.style.color = color;
            // 3D 转 2D
            const vec = pos3d.clone();
            vec.project(camera);
            const x = (vec.x * .5 + .5) * window.innerWidth;
            const y = (-(vec.y * .5) + .5) * window.innerHeight;
            el.style.left = x + 'px'; el.style.top = y + 'px';
            document.getElementById('vfx-layer').appendChild(el);
            setTimeout(()=>el.remove(), 1000);
        }

        // --- 5. 语音跟读 ---
        const synth = window.speechSynthesis;
        
        function showCard(data) {
            isPaused = true;
            currentWordData = data;
            
            const modal = document.getElementById('card-modal');
            document.getElementById('c-icon').innerText = data.i;
            document.getElementById('c-word').innerText = data.en;
            document.getElementById('c-cn').innerText = data.cn;
            
            modal.classList.add('active');
            document.getElementById('mic-hint').innerText = "🔊 正在朗读...";
            document.getElementById('mic-btn').style.display = 'none'; // 先隐藏麦克风
            
            // 朗读
            synth.cancel();
            const u = new SpeechSynthesisUtterance(data.en);
            u.lang = 'en-US';
            u.rate = 0.9;
            u.onend = () => {
                document.getElementById('mic-hint').innerText = "🎤 点击麦克风跟读";
                document.getElementById('mic-btn').style.display = 'block';
            };
            synth.speak(u);
        }

        window.startSpeechRec = () => {
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            document.getElementById('mic-hint').innerText = "👂 正在听...";
            
            if(isIOS || !('webkitSpeechRecognition' in window)) {
                // iOS 模拟
                setTimeout(() => {
                    document.getElementById('mic-hint').innerText = "🌟 完美!";
                    onSuccess();
                }, 1000);
            } else {
                const Rec = window.webkitSpeechRecognition;
                const r = new Rec();
                r.lang = 'en-US';
                r.start();
                r.onresult = (e) => {
                    const t = e.results[0][0].transcript.toLowerCase();
                    if(t.includes(currentWordData.en.toLowerCase())) {
                        document.getElementById('mic-hint').innerText = "🌟 Perfect!";
                        onSuccess();
                    } else {
                        document.getElementById('mic-hint').innerText = "😅 再试一次";
                    }
                };
            }
        };

        function onSuccess() {
            playSynth('win');
            score += 20; document.getElementById('score').innerText = score;
            spawnExplosion(avatar.position, 0xffff00, 'normal');
            setTimeout(window.closeCard, 1500);
        }

        window.closeCard = () => {
            document.getElementById('card-modal').classList.remove('active');
            isPaused = false;
        };

        // --- 6. 音频引擎 ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSynth(type) {
            if(audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            
            const now = audioCtx.currentTime;
            if(type === 'pop') {
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(600, now);
                osc.frequency.exponentialRampToValueAtTime(100, now+0.1);
                gain.gain.setValueAtTime(0.3, now);
                gain.gain.linearRampToValueAtTime(0, now+0.1);
                osc.start(now); osc.stop(now+0.1);
            } else if(type === 'win') {
                osc.type = 'square';
                osc.frequency.setValueAtTime(500, now);
                osc.frequency.setValueAtTime(1000, now+0.1);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.linearRampToValueAtTime(0, now+0.3);
                osc.start(now); osc.stop(now+0.3);
            }
        }

        // --- 7. 视觉修复：强制视频检测 ---
        const videoEl = document.getElementById('input-video');
        const radarCtx = document.getElementById('radar-canvas').getContext('2d');
        const hands = new window.Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
        hands.setOptions({ maxNumHands: 1, minDetectionConfidence: 0.5 });

        hands.onResults(res => {
            radarCtx.clearRect(0,0,120,90);
            if (res.multiHandLandmarks && res.multiHandLandmarks.length > 0) {
                const p = res.multiHandLandmarks[0][8]; // 食指
                
                // 1. 雷达反馈
                radarCtx.fillStyle = '#0f0';
                radarCtx.beginPath();
                radarCtx.arc(p.x*120, p.y*90, 5, 0, Math.PI*2);
                radarCtx.fill();

                // 2. 坐标映射 (超灵敏版)
                // 解释：(0.5 - p.x) 镜像翻转。*50 放大系数。
                const rangeX = (camera.aspect * camera.position.z);
                const x = (0.5 - p.x) * (rangeX * 2.5); 
                const y = -(p.y - 0.5) * 35;
                
                handTarget.set(x, y, 0);
            }
        });

        // 强力检测循环：只要有视频流，就强行送入 MediaPipe
        async function detectLoop() {
            if (videoEl.readyState >= 2 && !videoEl.paused) {
                await hands.send({image: videoEl});
            }
            requestAnimationFrame(detectLoop);
        }

        // 启动函数
        window.startGame = async (cat) => {
            currentPool = DB[cat];
            document.getElementById('lobby-screen').style.display = 'none';
            document.getElementById('game-ui').style.display = 'block';
            
            audioCtx.resume(); // 解锁音频
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'user', width: {ideal: 640}, height: {ideal: 480} }
                });
                videoEl.srcObject = stream;
                videoEl.play();
                detectLoop(); // 启动检测
            } catch(e) {
                alert("相机启动失败，请检查权限");
            }

            animate();
            setInterval(spawnBalloon, 1800);
        };

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
        
        // 预加载语音
        window.speechSynthesis.onvoiceschanged = () => window.speechSynthesis.getVoices();
    </script>
</body>
</html>