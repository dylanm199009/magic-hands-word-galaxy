// --- 1. 海量词库数据库 (Categories) ---
const WORD_DB = {
    animals: [
        { en: 'LION', cn: '狮子', icon: '🦁', pron: '/ˈlaɪ.ən/', color: 0xffa502 },
        { en: 'TIGER', cn: '老虎', icon: '🐯', pron: '/ˈtaɪ.ɡər/', color: 0xff6348 },
        { en: 'RABBIT', cn: '兔子', icon: '🐰', pron: '/ˈræb.ɪt/', color: 0xffffff },
        { en: 'PANDA', cn: '熊猫', icon: '🐼', pron: '/ˈpæn.də/', color: 0x2f3542 },
        { en: 'MONKEY', cn: '猴子', icon: '🐵', pron: '/ˈmʌŋ.ki/', color: 0xe1b12c },
        { en: 'ELEPHANT', cn: '大象', icon: '🐘', pron: '/ˈel.ɪ.fənt/', color: 0xa4b0be }
    ],
    food: [
        { en: 'BURGER', cn: '汉堡', icon: '🍔', pron: '/ˈbɜː.ɡər/', color: 0xff9f43 },
        { en: 'PIZZA', cn: '披萨', icon: '🍕', pron: '/ˈpiːt.sə/', color: 0xff6b6b },
        { en: 'APPLE', cn: '苹果', icon: '🍎', pron: '/ˈæp.əl/', color: 0xff4757 },
        { en: 'ICE CREAM', cn: '冰淇淋', icon: '🍦', pron: '/ˈaɪs ˌkriːm/', color: 0x70a1ff },
        { en: 'CAKE', cn: '蛋糕', icon: '🍰', pron: '/keɪk/', color: 0xffcccc }
    ],
    vehicles: [
        { en: 'CAR', cn: '汽车', icon: '🚗', pron: '/kɑːr/', color: 0x3742fa },
        { en: 'BUS', cn: '巴士', icon: '🚌', pron: '/bʌs/', color: 0xffa502 },
        { en: 'ROCKET', cn: '火箭', icon: '🚀', pron: '/ˈrɑː.kɪt/', color: 0x5352ed },
        { en: 'PLANE', cn: '飞机', icon: '✈️', pron: '/pleɪn/', color: 0x1e90ff },
        { en: 'SHIP', cn: '轮船', icon: '🚢', pron: '/ʃɪp/', color: 0x2ed573 }
    ],
    nature: [
        { en: 'SUN', cn: '太阳', icon: '☀️', pron: '/sʌn/', color: 0xffdd59 },
        { en: 'MOON', cn: '月亮', icon: '🌙', pron: '/muːn/', color: 0xf39c12 },
        { en: 'TREE', cn: '大树', icon: '🌳', pron: '/triː/', color: 0x2ecc71 },
        { en: 'FLOWER', cn: '花朵', icon: '🌸', pron: '/ˈflaʊ.ər/', color: 0xff9ff3 },
        { en: 'RAIN', cn: '下雨', icon: '🌧️', pron: '/reɪn/', color: 0x74b9ff }
    ]
};

// 当前游戏数据
let currentLevelData = [];
let score = 0;
let isPaused = false;

// --- 2. 语音引擎管理器 (Fix TTS) ---
const TTS = {
    voices: [],
    init: function() {
        window.speechSynthesis.onvoiceschanged = () => {
            this.voices = window.speechSynthesis.getVoices();
        };
        this.voices = window.speechSynthesis.getVoices();
    },
    speak: function(text) {
        window.speechSynthesis.cancel(); // 停止上一个
        const u = new SpeechSynthesisUtterance(text);
        u.rate = 0.9;
        // 尝试寻找英语声音
        const enVoice = this.voices.find(v => v.lang.includes('en-US') || v.lang.includes('en-GB'));
        if (enVoice) u.voice = enVoice;
        window.speechSynthesis.speak(u);
    }
};
TTS.init();

// --- 3. 3D 场景核心 ---
const canvas = document.getElementById('game-canvas');
const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
const renderer = new THREE.WebGLRenderer({ canvas: canvas, alpha: true, antialias: true });
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.setPixelRatio(window.devicePixelRatio);
camera.position.z = 16; // 稍微拉远一点视野

// 3A 灯光
scene.add(new THREE.AmbientLight(0xffffff, 0.7));
const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
dirLight.position.set(5, 10, 5);
scene.add(dirLight);

// --- 4. 可爱化身系统 (Cute Avatar) ---
// 我们用代码画一个“大眼萌飞船”
function createAvatar() {
    const group = new THREE.Group();

    // 身体 (白色圆球)
    const bodyGeo = new THREE.SphereGeometry(1, 32, 32);
    const bodyMat = new THREE.MeshPhongMaterial({ color: 0xffffff, shininess: 100 });
    const body = new THREE.Mesh(bodyGeo, bodyMat);
    group.add(body);

    // 眼睛 (两个黑色小球)
    const eyeGeo = new THREE.SphereGeometry(0.2, 16, 16);
    const eyeMat = new THREE.MeshBasicMaterial({ color: 0x000000 });
    const eyeL = new THREE.Mesh(eyeGeo, eyeMat);
    eyeL.position.set(-0.35, 0.1, 0.85);
    const eyeR = new THREE.Mesh(eyeGeo, eyeMat);
    eyeR.position.set(0.35, 0.1, 0.85);
    group.add(eyeL);
    group.add(eyeR);

    // 腮红 (粉色)
    const blushGeo = new THREE.SphereGeometry(0.15, 16, 16);
    const blushMat = new THREE.MeshBasicMaterial({ color: 0xff9ff3